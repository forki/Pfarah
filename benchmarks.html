<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Benchmarking
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="Parses files generated by the Clausewitz engine"/>
    <meta name="author" content="Nick Babcock <nbabcock19@hotmail.com>"/>
    <link rel="icon" href="/Pfarah/favicon.ico">

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link type="text/css" rel="stylesheet" href="/Pfarah/content/style.css" />
    <script type="text/javascript" src="/Pfarah/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://fsharp.org">fsharp.org</a></li>
          <li><a href="http://github.com/nickbabcock/Pfarah">github page</a></li>
        </ul>
        <h3 class="muted"><a href="/Pfarah/index.html">Pfarah</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="Benchmarking" class="anchor" href="#Benchmarking">Benchmarking</a></h1>
<p>Pfarah is fast. Pfarah takes advantage of the shape of the data to supply
hyper-optimized functions that far outstrip the .NET's own libraries. It used
to be the case that determining if "1.000" was a number, a datetime, or just a
plain string consumed most of the CPU time when parsing. After writing
optimized functions, the previous bottleneck is barely a blip.</p>
<p>I would like to state that for 99% of use cases, .NET's own libraries are
sufficiently fast as they can handle any format and culture. It's only when one
can make certain assumptions about the data can optimizations be utilized.</p>
<p>Using <a href="https://github.com/PerfDotNet/BenchmarkDotNet">BenchmarkDotNet</a>, the
following breaks down the performance difference between Pfarah's
hyper-optimized functions (prefixed with <code>pfarah</code>) and .NET libraries (prefixed
with <code>bcl</code>). I'll call out performance characteristics of both the happy path
(eg. parsing strings that are dates/numbers) and parsing the sad path (eg.
parsing strings that are no dates/numbers). Often the sad path is even more
important than the happy path when parsing a file with very few numbers and
dates.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
</pre></td>
<td class="snippet"><pre class="fssnip"><code lang="ini">
BenchmarkDotNet=v0.9.7.0
OS=Microsoft Windows NT 6.2.9200.0
Processor=Intel(R) Core(TM) i7-6700K CPU 4.00GHz, ProcessorCount=8
Frequency=3914058 ticks, Resolution=255.4893 ns, Timer=UNKNOWN
HostCLR=MS.NET 4.0.30319.42000, Arch=32-bit RELEASE
JitModules=clrjit-v4.6.1080.0

Type=ParseDateTime  Mode=Throughput

</code></pre></td></tr></table>
<h2><a name="Parsing-Doubles" class="anchor" href="#Parsing-Doubles">Parsing Doubles</a></h2>
<p><img src="/Pfarah/img/doubles-parsing.png" alt="pfara-benchmark" /></p>
<ul>
<li>
Happy path: More than 10x improvement for simple numbers (50). As numbers
grow complex (more numbers, decimals) performance improvement drops to 5x.
</li>
<li>Sad path: 15x improvement for data that obviously isn't a number (abc)</li>
</ul>
<h2><a name="Parsing-DateTimes" class="anchor" href="#Parsing-DateTimes">Parsing DateTimes</a></h2>
<p><img src="/Pfarah/img/parse-dates.png" alt="pfara-benchmark" /></p>
<ul>
<li>Happy path: 3-4x improvement depending on if the hour part of a date is omitted.</li>
<li>Sad path: &gt; 40x improvement for data that obviously isn't a date (abc), but if the date is closer to an actual date, then performance improvement drops to 5x.</li>
</ul>
<p>Squirrelling away the code used to generate the plots from the csv output from BenchmarkDotnet</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
</pre></td>
<td class="snippet"><pre class="fssnip"><code lang="R">library(ggplot2)
library(dplyr)
library(stringr)
library(readr)

bench_plot &lt;- function(fp, title) {
    # Converts "2.313 ns" to 2.313
    toNs &lt;- function(x) {
        split &lt;- str_split(x, " ")
        num &lt;- as.numeric(split[[1]][[1]])
        factor &lt;- switch(split[[1]][[2]], ns=1, us=1000, ms=1000*1000)
        num * factor
    }
    vtoNs &lt;- Vectorize(toNs)

    read_csv2(fp) %&gt;%
        select(Method, Payload, Median, StdDev) %&gt;%
        mutate(Median = vtoNs(Median), StdDev = vtoNs(StdDev),
               Method = ifelse(str_detect(Method, "bcl"), "BCL", "Pfarah")) %&gt;%
        ggplot(mapping = aes(Payload, Median, fill = Method)) +
        geom_bar(stat = 'identity', position='dodge') +
        coord_flip() + ylab("Median (ns)") + ggtitle(title)
}

bench_plot("ParseDateTime-report.csv",
    "Time Attempting to Parse Dates (Smaller Bar = Faster)")
bench_plot("ParseDouble-report.csv",
    "Time Attempting to Parse Doubles (Smaller Bar = Faster)")
</code></pre></td></tr></table>


        </div>
        <div class="span3">
          <img src="/Pfarah/img/logo.png" alt="F# Project" style="width:150px;margin:10px" />  
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">Pfarah</li>
            <li><a href="/Pfarah/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://nuget.org/packages/Pfarah">Get Library via NuGet</a></li>
            <li><a href="http://github.com/nickbabcock/Pfarah">Source Code on GitHub</a></li>
            <li><a href="/Pfarah/license.html">License</a></li>
            <li><a href="/Pfarah/release-notes.html">Release Notes</a></li>
            
            <li class="nav-header">Getting started</li>
            <li><a href="/Pfarah/tutorial.html">Sample tutorial</a></li>

            <li class="nav-header">Documentation</li>
            <li><a href="/Pfarah/reference/index.html">API Reference</a></li>
            <li><a href="/Pfarah/data-format.html">Data format</a></li>
            <li><a href="/Pfarah/benchmarks.html">Benchmarks</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/nickbabcock/Pfarah"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
  </html>
